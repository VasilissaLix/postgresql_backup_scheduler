# Общее описание
Описана настройка следующего функционала по расписанию
•	Создание резервной копии
•	Восстановление из резервной и проверка работоспособности
•	Ротация резервных копий
! Предполагается, что хранение резервных копий осуществляется на отдельном сервере. Далее в инструкции будет обозначаться backup_server. 
Ожидаемый результат: 
1 раз в день снимается резервная копия и сохраняется на сервер  backup_server, в файл backup_postgres_log.csv записывается статус снятия. Далее база восстанавливается из снятой копии на сервере backup_server, в файл backup_postgres_log.csv записывается статус восстановления. Удаление резервных копий, созданных 7 и более дней назад, в файл backup_postgres_log.csv записывается количество занятого места на диске.
Автоматизация реализована с помощью CRON-джоб, выполняющих скрипты. Всего 3 скрипта:
1)	get_backup.sh
2)	restore_backup.sh
3)	delete_old_backups.sh
Каждый скрипт записывает информацию в файл backup_postgres_log.csv. Файл должен находиться в папке для бекапов.

# Алгоритм настройки
1.	Убедитесь, что можете получить доступ с сервера backup_server к рабочему кластеру postgresql.
2.	На сервере backup_server должен быть установлен postgresql той же версии, что и на рабочем сервере.
3.	Создайте папку на backup_server и поместите в неё скрипты
4.	В этой же папке создайте файл backup_postgres_log.csv и вставьте заголовок столбцов:
timestamp,parameter,value
5.	Запустить скрипт get_backup.sh. Проверить, что резервная копия сохранилась в папку, указанную вами в скрипте. Должно быть 3 файла: base.tar.gz, pg_wal.tar.gz, backup_manifest. Проверьте, что в backup_postgres_log.csv записался статус снятия бекапа. Если вставлена запись failure, убедитесь, что можете подключиться с данного хоста к хосту реплики. 
6.	Запустить скрипт restore_backup.sh. Проверить, что postgresql находится в запущенном состоянии на backup_server. Подключитесь к postgresql и проверьте, что снятые данные корректные. Проверьте, что в папке, куда сохраняются бекапы, также есть папка pg_wal и в ней есть данные. Проверьте, что в backup_postgres_log.csv записался статус восстановления из бекапа. Если вставлена запись failure, проверьте логи postgesql на данном хосте.
7.	Чтобы проверить работу скрипта delete_old_backups.sh, необходимо удалить условие удаления по времени. Создайте копию скрипта и поменяйте в ней команду 
find . ! -name . -type d -mtime 7 -exec rm -rf {} +
на 
find . ! -name . -type d -exec rm -rf {} +
Запустите копию. Проверьте, что все данные в папке для бекапов удалены, при этом сама папка для бекапов должна остаться. Проверьте, что в backup_postgres_log.csv записались данные по количеству занятого места на диске. Если всё успешно, можно удалить копию скрипта.
8.	Задайте настройка CRON так, чтобы скрипты выполнялись в следующей последовательности: get_backup.sh, restore_backup.sh, delete_old_backups.sh. 
Пример моих настроек для бекапирования:
vim /var/spool/cron/root
0 10 * * * /opt/cron_results/delete_old_backups.sh
0 9 * * * /opt/cron_results/get_backup.sh
30 9 * * * /opt/cron_results/restore_backup.sh
Таким образом, снятие бекапа происходит в 9:00, в 9:30 – восстановление, 10:00 – удаление.


# Скрипты
## get_backup.sh
В переменную backups_dir запишите путь к папке для бекапов. Она должна существовать на сервере. 
В переменную postgres_host запишите адрес сервера postgres. 
Команда pg_basebackup:
•	-p запишите порт рабочего кластера postgresql
•	-U запишите пользователя для обращения к хосту реплики

## restore_backup.sh
В переменную backups_dir запишите путь к папке для бекапов. Она должна существовать на сервере. 
В переменную version запишите версию postgresql. 
За успешность восстановления считаем успешный запуск postgresql из резервной копии.

## delete_old_backups.sh
В переменную backups_dir запишите путь к папке для бекапов. Она должна существовать на сервере. 
В переменной partition запишите раздел в файловой системе, по которому необходимо отслеживать используемое пространство. Закомменитруйте объявление переменной и запись в логи, если в этом нет необходимости.
В команде поиска в параметре mtime задайте условие удаления по времени. 
Примеры:
-mtime 7 – удаление директорий, созданных 7 и более дней назад
-mtime +14 - удаление директорий, созданных строго более 14 дней назад

# Мониторинг
Есть возможность организовать мониторинг с отображением статуса процесса бекапирования.
В каждом скрипте в конце выполняется команда отправки сообщения в opensearch (см. команду curl в конце):
1) get_backup.sh - статус создания резервной копии
2) restore_backup.sh - статус восстановления из снятой резервной копии
3) delete_old_backups.sh - размер занятого пространства в указанной секции диска в процентах
В переменнуую os_host запишите адрес, где расположен Opensearch.

Запрос на создание индекса "backup_postgres":
PUT /backup_postgres
{
  "settings": {
    "index": {
      "number_of_shards": 2,
      "number_of_replicas": 1
    }
  },
  "mappings": {
    "properties": {
      "@timestamp": {
            "type": "date"
          },
      "backup_status": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
            "ignore_above": 256
          }
        }
      },
      "disk_usage": {
        "type": "integer"
      },
      "restore_status": {
        "type": "text",
        "fields": {
          "keyword": {
            "type": "keyword",
              "ignore_above": 256
          }
        }
      }
    }
  }
}
